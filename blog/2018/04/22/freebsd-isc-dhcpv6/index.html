<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>FreeBSD DHCPv6 | Silmaril's Blog</title><meta property="og:title" content="Silmaril's Blog"><link rel=stylesheet href=/main.min.css><meta name=description content><meta name=author content="Benoit Plessis"><link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Prompt:wght@700&display=swap" rel=stylesheet></head><body class=page><header class=top-header><nav><ul class=top-nav><li class=top-nav__logo><a href=/>Silmaril's Blog</a></li><li class=top-nav__link><a href=/pages/about>About</a><li class=top-nav__link><a href=/blog/>Archives</a><li class=top-nav__link><a href=/pages/links>Links</a></ul></nav></header><main class=main-content><aside><h1>Author</h1><div class=profil><h4><a href=/pages/about/>Benoit Plessis</a></h4><img src=/images/profil.png width=100 height=100 alt="Author Profil"><p>System & Network Engineer - France</p></div><p><small>Simple sysadmin notes and thought on the world… Yeah no just kidding, some less than special rant and diary.</small></p><nav id=social><ul><li><a href=mailto:benoit@plessis.info class="social-button email-button">Email Contact</a></li><li><a href="https://twitter.com/silmaril34?ref_src=twsrc%5Etfw" class="social-button twitter-follow-button">Follow @silmaril34</a></li><li><a href=https://github.com/bplessis class="social-button github-follow-button" aria-label="Follow @bplessis on GitHub">Follow @bplessis</a></li></ul></nav></aside><div class=page-content><article id=content><p>In <a href=/blog/2017/02/14/freebsd-setup/ title="FreeBSD Setup">FreeBSD Setup</a> i detailed the use of KAME&rsquo;s dhcp client to authentify and request an IPv6 block to be routed onto the server.</p><p>However as it seem this client has a tendancy to misbehave and trigger the hosting provider DOS defense mechanism (mainly rebooting the serveur after disabling dhcp service autorisations, not fun).</p><p>While checking around with friend it seems i wasn&rsquo;t the first one hit by this and that the solution was to switch over to ISC&rsquo;s dhcp service, with a little twist (freebsd package for isc-dhcp doesn&rsquo;t include an init script for dhcpv6).</p><h1 id=installation>Installation</h1><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@frb:~ <span class=c1># pkg install isc-dhcp44-client</span></span></span></code></pre></div><p>However as stated before the package doesn&rsquo;t include a statup script for ipv6 service, so there is one you need to paste into <code>/usr/local/etc/rc.d/dhclient6</code> (courtesy of <a href=https://t37.net>neuro</a>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=cp>#!/bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># PROVIDE: dhclient6</span>
</span></span><span class=line><span class=cl><span class=c1># REQUIRE: DAEMON</span>
</span></span><span class=line><span class=cl><span class=c1># KEYWORD: dhcp</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Add the following lines to /etc/rc.conf to enable dhclient6:</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># dhclient6_enable=&#34;YES&#34;</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>. /etc/rc.subr
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>name</span><span class=o>=</span><span class=s2>&#34;dhclient6&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>desc</span><span class=o>=</span><span class=s2>&#34;ISC DHCPv6 client&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>rcvar</span><span class=o>=</span><span class=s2>&#34;dhclient6_enable&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>start_cmd</span><span class=o>=</span><span class=s2>&#34;dhclient6_start&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>stop_cmd</span><span class=o>=</span><span class=s2>&#34;dhclient6_stop&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>dhclient6_start<span class=o>()</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>          /usr/local/sbin/dhclient -cf <span class=s2>&#34;</span><span class=si>${</span><span class=nv>dhclient6_conf</span><span class=si>}</span><span class=s2>&#34;</span> -P -v <span class=s2>&#34;</span><span class=si>${</span><span class=nv>dhclient6_iface</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>dhclient6_stop<span class=o>()</span>
</span></span><span class=line><span class=cl><span class=o>{</span> 
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>[</span> -r <span class=s2>&#34;</span><span class=si>${</span><span class=nv>dhclient6_pid</span><span class=si>}</span><span class=s2>&#34;</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>kill</span> -- -<span class=k>$(</span>cat <span class=s2>&#34;</span><span class=si>${</span><span class=nv>dhclient6_pid</span><span class=si>}</span><span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>    rm -f <span class=s2>&#34;</span><span class=si>${</span><span class=nv>dhclient6_pid</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>load_rc_config <span class=si>${</span><span class=nv>name</span><span class=si>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>: <span class=si>${</span><span class=nv>dhclient6_enable</span><span class=p>=</span><span class=s2>&#34;NO&#34;</span><span class=si>}</span>
</span></span><span class=line><span class=cl>: <span class=si>${</span><span class=nv>dhclient6_pid</span><span class=p>=</span><span class=s2>&#34;/var/run/dhclient6.pid&#34;</span><span class=si>}</span>
</span></span><span class=line><span class=cl>: <span class=si>${</span><span class=nv>dhclient6_conf</span><span class=p>=</span><span class=s2>&#34;/usr/local/etc/dhclient6.conf&#34;</span><span class=si>}</span>
</span></span><span class=line><span class=cl>: <span class=si>${</span><span class=nv>dhclient6_iface</span><span class=p>=</span><span class=s2>&#34;&#34;</span><span class=si>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>run_rc_command <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span></span></span></code></pre></div><h1 id=configuration>Configuration</h1><p>Configuration is simpler than using KAME&rsquo;s dhcp6c, most notably the DUID doesn&rsquo;t need some magic, only need to write it up in a <code>dhclient6.conf</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>interface <span class=s2>&#34;bge0&#34;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        send dhcp6.client-id 00:03:xx:xx:xx:xx:xx:xx:xx:xx<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></div><p>And activate everything in <code>rc.conf</code> like before, there is however one minor diff with previous configuration, i didn&rsquo;t had time to investigate as of why but <code>dhcp6c</code> setup did add and ipv6 address to the requesting interface, current <code>isc-dhcp</code> does not, so i added an alias:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>ifconfig_bge0_ipv6</span><span class=o>=</span><span class=s2>&#34;inet6 -ifdisabled accept_rtadv up&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>ifconfig_bge0_aliases</span><span class=o>=</span><span class=s2>&#34;inet6 alias 2001:bc8:2909:xx:y:z prefixlen 128&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#dhcp6c_enable=&#34;YES&#34;</span>
</span></span><span class=line><span class=cl><span class=c1>#dhcp6c_interfaces=&#34;bge0&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>dhclient6_iface</span><span class=o>=</span><span class=s2>&#34;bge0&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>dhclient6_enable</span><span class=o>=</span><span class=s2>&#34;YES&#34;</span></span></span></code></pre></div><h1 id=cleanup>Cleanup</h1><p>When happy with this new setup you can do some cleanup:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@frb:~ <span class=c1># pkg remove dhcp6</span>
</span></span><span class=line><span class=cl>root@frb:~ <span class=c1># /bin/rm /usr/local/etc/dhcp6c.conf /var/db/dhcp6c_duid</span></span></span></code></pre></div></article><hr><nav id=timenav><div id=previnsection><h3>Older</h3><article class=post-link><header><h1><a href=/blog/2018/04/17/blog-jekyll/>Upgrading the blog, day 2</a></h1><p>Last time up on setting up nginx to make PageSpeed Insight happy, we saw that tweaking the webserver wasn&rsquo;t enough, so now we will have to work on the content.
Compress html output minify & pre-compress js/css assets optimize media assets Compress (minify) html output There are a bunch of solutions for this step, as of now i&rsquo;m using the simpler approach of &ldquo;jekyll-compress&rdquo;, it&rsquo;s an html &ldquo;compressor&rdquo; that work in pure &ldquo;Liquid&rdquo; (the templating language of jekyll), so no strange ruby installation and whatnot, you only need to fetch the compress.</p></article></div><div id=nextinsection><h3>Newer</h3><article class=post-link><header><h1><a href=/blog/2019/12/06/opscode-chef-letsencrypt/>Let's Encrypt Chef-Server</a></h1><p>Hi,
So today i wanted to switch our chef-server certificates from an old internal pki with issues (SHA1 &mldr;) to another solution, and since we are avid users of Let&rsquo;s Encrypt this was my first idea.
However i quickly stumble onto an issue, the chef-server private cookbook aren&rsquo;t &lsquo;compatible&rsquo; with this (ie there is no way to insert some custom nginx rules on the correct location to allow serving of /.</p></article></div></nav></div></main><footer><div>©2022. Built with <a href=https://gohugo.com/>Hugo</a> custom layout loosely based on <a href=https://github.com/ellekasai/shiori>Jekyll Shiori Theme</a>.</div><div><p>Using: <a href=https://www.w3.org/html/logo/><img src=https://www.w3.org/html/logo/badge/html5-badge-h-css3.png alt="HTML5 Powered with CSS3 / Styling" title="HTML5 Powered with CSS3 / Styling" width=33 height=16></a> <a href="https://validator.w3.org/check?uri=/">Validate</a></p></div></footer></body></html>