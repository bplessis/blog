<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Upgrading the blog, day 1 | Silmaril's Blog</title><meta property="og:title" content="Silmaril's Blog"><link rel=stylesheet href=/main.min.css><meta name=description content><meta name=author content="Benoit Plessis"><link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Prompt:wght@700&display=swap" rel=stylesheet></head><body class=page><header class=top-header><nav><ul class=top-nav><li class=top-nav__logo><a href=/>Silmaril's Blog</a></li><li class=top-nav__link><a href=/pages/about>About</a><li class=top-nav__link><a href=/blog/>Archives</a><li class=top-nav__link><a href=/pages/links>Links</a></ul></nav></header><main class=main-content><aside><h1>Author</h1><div class=profil><h4><a href=/pages/about/>Benoit Plessis</a></h4><img src=/images/profil.png width=100 height=100 alt="Author Profil"><p>System & Network Engineer - France</p></div><p><small>Simple sysadmin notes and thought on the worldâ€¦ Yeah no just kidding, some less than special rant and diary.</small></p><nav id=social><ul><li><a href=mailto:benoit@plessis.info class="social-button email-button">Email Contact</a></li><li><a href="https://twitter.com/silmaril34?ref_src=twsrc%5Etfw" class="social-button twitter-follow-button">Follow @silmaril34</a></li><li><a href=https://github.com/bplessis class="social-button github-follow-button" aria-label="Follow @bplessis on GitHub">Follow @bplessis</a></li></ul></nav></aside><div class=page-content><article id=content><p>A year has past since the beginning of this little experiment, and some results are already showing:</p><ul><li>i&rsquo;m not very prolific ^^</li><li>i&rsquo;m becoming more and more grumpy</li><li>i don&rsquo;t like my blog&rsquo;s setup (but didn&rsquo;t find better for now)
.</li></ul><p>So yeah, new year was 4 month ago and still nothing new here, my article on bind, dnssec and knot hasn&rsquo;t moved further, but work-related issues send me back here to make some experiments, our SEO consultants where reportings issues on our client&rsquo;s website and where in need of informations. Using the provided analytics software (PageSpeed Insight) on this blog gave horrendous results:</p><ul><li>This is a static content blog but not cache informations was returned by the webserver</li><li>HTML, Javascript and CSS code where not exactly optimized</li><li>Text data wasn&rsquo;t compressed on the way to the browser</li></ul><p>Well not everything was bad, at least SSL was working OK and even more so HTTP/2.0 is active on the setup, however this isn&rsquo;t part of PageSpeed Insight analysis (so much for all the SEO-fuss on https/&mldr;).</p><h2 id=enhancing-webserver-configuration>Enhancing webserver configuration</h2><p>As said previously this is an experementation server, so as if using FreeBSD wasn&rsquo;t enough i also used nginx on many services, so there is that i didn&rsquo;t look over levergage browser cache, compressing stream,.. So there is the job for today.</p><p>The starting point is a pretty straightforward configuration, i have setup two server block, one for the http service with a forced 301 redirect over HTTPS url and the second for the HTTPS service. Only peculiarity is the IPv4 private IP that is used, having only one IPv4 address has made me a little &ldquo;creative&rdquo; and so i&rsquo;m using an haproxy redirect service which allow real source IP preservation, even with SSL stream using special protocol:<div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl>   <span class=k>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>listen</span>       <span class=n>10.x.y.z</span><span class=p>:</span><span class=mi>80</span>       <span class=s>proxy_protocol</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>listen</span>       <span class=s>[2001:bc8:2909:101::4]:80</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kn>server_name</span>  <span class=s>blog.plessis.info</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kn>set_real_ip_from</span>                <span class=mi>10</span><span class=s>.x.y.w</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>real_ip_header</span>                  <span class=s>proxy_protocol</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>real_ip_recursive</span>               <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># enforce https
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kn>location</span> <span class=s>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=kn>return</span> <span class=mi>301</span> <span class=s>https://</span><span class=nv>$server_name$request_uri</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>listen</span>       <span class=n>10.x.y.z</span><span class=p>:</span><span class=mi>443</span>      <span class=s>ssl</span> <span class=s>http2</span> <span class=s>proxy_protocol</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>listen</span>       <span class=s>[2001:bc8:2909:101::4]:443</span> <span class=s>ssl</span> <span class=s>http2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kn>server_name</span>  <span class=s>blog.plessis.info</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Set the client remote address to the one sent in the X_FORWARDED_FOR header from trusted addresses.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kn>set_real_ip_from</span>                <span class=mi>10</span><span class=s>.x.y.w</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>real_ip_header</span>                  <span class=s>proxy_protocol</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>real_ip_recursive</span>               <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kn>ssl_certificate</span>      <span class=s>/usr/local/etc/dehydrated/certs/blog.plessis.info/fullchain.pem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>ssl_certificate_key</span>  <span class=s>/usr/local/etc/dehydrated/certs/blog.plessis.info/privkey.pem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kn>ssl_ciphers</span>  <span class=s>HIGH:!aNULL:!MD5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>ssl_prefer_server_ciphers</span>  <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kn>location</span> <span class=s>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kn>root</span>   <span class=s>/usr/local/www/nginx/data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kn>index</span>  <span class=s>index.html</span> <span class=s>index.htm</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># redirect server error pages to the static page /50x.html
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>#
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kn>error_page</span>   <span class=mi>500</span> <span class=mi>502</span> <span class=mi>503</span> <span class=mi>504</span>  <span class=s>/50x.html</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>location</span> <span class=p>=</span> <span class=s>/50x.html</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kn>root</span>   <span class=s>/usr/local/www/nginx-dist</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span></span></span></code></pre></div></p><h3 id=browser-cache>Browser Cache</h3><p>So we need to add a few rules, for starter leveraging browser cache is usually done by adding a location block matching common static content extensions and adding an expires keyword:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl>    <span class=k>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>[...]</span>
</span></span><span class=line><span class=cl>        <span class=s>location</span> <span class=p>~</span><span class=sr>*</span> <span class=s>\.(js|css|jpg|png)</span>$ <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kn>expires</span> <span class=s>120d</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=kn>[...]</span>
</span></span><span class=line><span class=cl>    <span class=err>}</span></span></span></code></pre></div><p>However widespread this is (it even found it&rsquo;s way in some configuration sample for many web applications) this didn&rsquo;t feel right compared to the ExpiresByType of apache&rsquo;s mod_deflate.
Also i had to repeat the root stanza which didn&rsquo;t feel very nice.</p><p>Luckily i found another way here <a href=https://www.digitalocean.com/community/tutorials/how-to-implement-browser-caching-with-nginx-s-header-module-on-ubuntu-16-04>Digital Ocean Community</a>: setting up an &ldquo;expire map&rdquo; feel much more like what i&rsquo;m used to, so there i go.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl>    <span class=c1># Expires map
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>map</span> <span class=nv>$sent_http_content_type</span> <span class=nv>$expires</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>default</span>                    <span class=no>off</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>text/html</span>                  <span class=s>epoch</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>text/css</span>                   <span class=s>max</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>application/javascript</span>     <span class=s>max</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>~image/</span>                    <span class=s>max</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>[...]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>[...]</span>
</span></span><span class=line><span class=cl>        <span class=s>server_name</span>  <span class=s>blog.plessis.info</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>root</span>   <span class=s>/usr/local/www/nginx/data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kn>[...]</span>
</span></span><span class=line><span class=cl>        <span class=s>location</span> <span class=s>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kn>index</span>  <span class=s>index.html</span> <span class=s>index.htm</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kn>expires</span> <span class=nv>$expires</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>[...]</span>
</span></span><span class=line><span class=cl>    <span class=err>}</span></span></span></code></pre></div><p>This feel much better !</p><h3 id=content-compression>Content compression</h3><p>For this there is not much discussion here, the setup is quite simple so no need to rack our brains. Given the nature of the website (statically <em>generated</em>) i also included an option to detect and serve pre-generated compressed ressources, this will however need some work on jekyll side but i&rsquo;m getting ahead of myself :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl>    <span class=k>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>[...]</span>
</span></span><span class=line><span class=cl>        <span class=c1>#
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1># Gzip Settings
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>##
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=s>gzip</span> <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>gzip_disable</span> <span class=s>&#34;msie6&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kn>gzip_vary</span> <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>gzip_proxied</span> <span class=s>any</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>gzip_comp_level</span> <span class=mi>8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>gzip_min_length</span> <span class=mi>256</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>gzip_types</span> <span class=s>text/plain</span> <span class=s>text/css</span> <span class=s>application/json</span> <span class=s>application/javascript</span> <span class=s>text/xml</span> <span class=s>application/xml</span> <span class=s>application/xml+rss</span> <span class=s>text/javascript</span> <span class=s>image/svg+xml</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Allow serving pre-compressed files
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kn>gzip_static</span> <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>[...]</span>
</span></span><span class=line><span class=cl>    <span class=err>}</span></span></span></code></pre></div><h3 id=security-headers-hsts-x-frame-option->Security Headers: HSTS, X-Frame-Option, &mldr;</h3><p>While being there, adding a few security-related headers couldn&rsquo;t hurt so there we go:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl>    <span class=k>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>[...]</span>
</span></span><span class=line><span class=cl>        <span class=c1>#
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1># Security headers:
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=s>add_header</span> <span class=s>Strict-Transport-Security</span> <span class=s>&#34;max-age=31536000</span><span class=p>;</span> <span class=kn>includeSubDomains&#34;</span> <span class=s>always</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kn>add_header</span> <span class=s>X-Content-Type-Options</span> <span class=s>nosniff</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>add_header</span> <span class=s>X-Frame-Options</span> <span class=s>&#34;SAMEORIGIN&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>add_header</span> <span class=s>X-XSS-Protection</span> <span class=s>&#34;1</span><span class=p>;</span> <span class=kn>mode=block&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>add_header</span> <span class=s>X-Download-Options</span> <span class=s>noopen</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>add_header</span> <span class=s>X-Permitted-Cross-Domain-Policies</span> <span class=s>none</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kn>[...]</span>
</span></span><span class=line><span class=cl>    <span class=err>}</span></span></span></code></pre></div><h2 id=conclusion>Conclusion</h2><p>This helped a bit increasing PageSpeed score but it wasn&rsquo;t the promised/foretold revolution you could hear here and there.</p><p>So, next step is content optimisation !</p><p>PS: You can download the <a href=nginx_blog_20180417.conf>NGINX Configuration</a>.</p></article><hr><nav id=timenav><div id=previnsection><h3>Older</h3><article class=post-link><header><h1><a href=/blog/2017/10/30/Drive-Failure-and-reinstall/>Drive Failure and reinstall</a></h1><p>Hi,
This weekend was one of thoses weekend &mldr; Sunday morning while trying to destroy an unused jail i got a zfs warning: &ldquo;pool is degraded&rdquo;.
As it turn out i was missing a drive in my zfs mirror setup, so heck .. no fun.
After a few email with the hosting company they recommended i migrate over a new server, which is running ok if you&rsquo;re reading this ;).</p></article></div><div id=nextinsection><h3>Newer</h3><article class=post-link><header><h1><a href=/blog/2018/04/17/blog-jekyll/>Upgrading the blog, day 2</a></h1><p>Last time up on setting up nginx to make PageSpeed Insight happy, we saw that tweaking the webserver wasn&rsquo;t enough, so now we will have to work on the content.
Compress html output minify & pre-compress js/css assets optimize media assets Compress (minify) html output There are a bunch of solutions for this step, as of now i&rsquo;m using the simpler approach of &ldquo;jekyll-compress&rdquo;, it&rsquo;s an html &ldquo;compressor&rdquo; that work in pure &ldquo;Liquid&rdquo; (the templating language of jekyll), so no strange ruby installation and whatnot, you only need to fetch the compress.</p></article></div></nav></div></main><footer><div>Â©2023. Built with <a href=https://gohugo.com/>Hugo</a> custom layout loosely based on <a href=https://github.com/ellekasai/shiori>Jekyll Shiori Theme</a>.</div><div><p>Using: <a href=https://www.w3.org/html/logo/><img src=https://www.w3.org/html/logo/badge/html5-badge-h-css3.png alt="HTML5 Powered with CSS3 / Styling" title="HTML5 Powered with CSS3 / Styling" width=33 height=16></a> <a href="https://validator.w3.org/check?uri=/">Validate</a></p></div></footer></body></html>