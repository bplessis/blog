<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Upgrading the blog, day 2 | Silmaril's Blog</title><meta property="og:title" content="Silmaril's Blog"><link rel=stylesheet href=/main.min.css><meta name=description content><meta name=author content="Benoit Plessis"><link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Prompt:wght@700&display=swap" rel=stylesheet></head><body class=page><header class=top-header><nav><ul class=top-nav><li class=top-nav__logo><a href=/>Silmaril's Blog</a></li><li class=top-nav__link><a href=/pages/about>About</a><li class=top-nav__link><a href=/blog/>Archives</a><li class=top-nav__link><a href=/pages/links>Links</a></ul></nav></header><main class=main-content><aside><h1>Author</h1><div class=profil><h4><a href=/pages/about/>Benoit Plessis</a></h4><img src=/images/profil.png width=100 height=100 alt="Author Profil"><p>System & Network Engineer - France</p></div><p><small>Simple sysadmin notes and thought on the world… Yeah no just kidding, some less than special rant and diary.</small></p><nav id=social><ul><li><a href=mailto:benoit@plessis.info class="social-button email-button">Email Contact</a></li><li><a href="https://twitter.com/silmaril34?ref_src=twsrc%5Etfw" class="social-button twitter-follow-button">Follow @silmaril34</a></li><li><a href=https://github.com/bplessis class="social-button github-follow-button" aria-label="Follow @bplessis on GitHub">Follow @bplessis</a></li></ul></nav></aside><div class=page-content><article id=content><p>Last time up on setting up nginx to make PageSpeed Insight happy, we saw that tweaking the webserver wasn&rsquo;t enough, so now we will have to work on the content.</p><ul><li>Compress html output</li><li>minify & pre-compress js/css assets</li><li>optimize media assets</li></ul><h2 id=compress-minify-html-output>Compress (minify) html output</h2><p>There are a bunch of solutions for this step, as of now i&rsquo;m using the simpler approach of &ldquo;jekyll-compress&rdquo;, it&rsquo;s an html &ldquo;compressor&rdquo; that work in pure &ldquo;Liquid&rdquo; (the templating language of jekyll), so no strange ruby installation and whatnot, you only need to fetch the compress.html layout generated in the releases, put it in your <code>_layouts/</code> folder and modify your layouts to use it as base. If there is a &ldquo;master&rdquo; default.html layout it&rsquo;s as simple as adding the following in the header:</p><pre tabindex=0><code class=language-liquid data-lang=liquid>---
layout: compress
---</code></pre><p>You can tweak the layout so as to filter jekyll to use this new plugin (altough using bundle seem to make this step optionnal)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>compress_html</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>clippings</span><span class=p>:</span><span class=w> </span><span class=l>all</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>comments</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&lt;!-- &#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34; --&gt;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># you can even remove &#39;optionnal&#39; end tags:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#  endings: [html, head, body, li, dt, dd, rt, rp, optgroup, option, colgroup, caption, thead, tbody, tfoot, tr, td, th]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>profile</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>blanklines</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ignore</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>envs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>local, dev, developpment]</span></span></span></code></pre></div><p><a href=https://github.com/penibelst/jekyll-compress-html>Jekyll Compress GitHub Projet</a>.</p><h2 id=minify-cssjs-optimize-media->Minify CSS/JS, Optimize media, ..</h2><p>There again exist a lot of solutions, i choose for now <a href=https://github.com/envygeeks/jekyll-assets>jekyll-assets</a> which promise a wide list of capabilities regarding assets management.</p><p>However using this tool wasn&rsquo;t exactly &ldquo;easy-peasy&rdquo;.</p><h3 id=setup>Setup</h3><p>My first attempt was to add the jekyll-assets gem to the system (debian on the laptop/FreeBSD on the server) like before, however this proved a bit chalenging (two gems needed different version for activesupport) and not very &ldquo;clieanish&rdquo;, so i looked into deployment using <code>bundle</code> tool.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@arcanin:~ <span class=c1># apt install ruby-bundler</span></span></span></code></pre></div><p>Then you need to write a <code>Gemfile</code>, listing all your dependencies:<div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>source</span> <span class=s2>&#34;https://rubygems.org&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>gem</span> <span class=s2>&#34;jekyll&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># jekyll-assets plugin itself</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>gem</span> <span class=s2>&#34;jekyll-assets&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Additional gems for jekyll-assets</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=n>gem</span> <span class=s2>&#34;coffee-script&#34;</span>  <span class=c1># We want to write our javascripts in CoffeeScript</span>
</span></span><span class=line><span class=cl><span class=n>gem</span> <span class=s2>&#34;uglifier&#34;</span>       <span class=c1># And we want our javascripts to be minified with UglifyJS</span>
</span></span><span class=line><span class=cl><span class=n>gem</span> <span class=s2>&#34;sass&#34;</span>           <span class=c1># And we want to write our stylesheets using SCSS/SASS</span>
</span></span><span class=line><span class=cl><span class=c1>#gem &#34;bootstrap-sass&#34; # For bootstrap 3.x, there is a &#34;funny&#34; gotcha here since jekyll-assets wrongly assume the gem is named boostrap-sass</span>
</span></span><span class=line><span class=cl><span class=n>gem</span> <span class=s2>&#34;bootstrap&#34;</span>      <span class=c1># For bootstrap 4</span>
</span></span><span class=line><span class=cl><span class=n>gem</span> <span class=s2>&#34;font-awesome-sass&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>gem</span> <span class=s2>&#34;image_optim&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>gem</span> <span class=s2>&#34;jemoji&#34;</span></span></span></code></pre></div></p><p>And execute <code>bunde install</code> to install all thoses dependencies.</p><p>NB: By default, even if you&rsquo;re not a privileged user, bundle will try to install gems globally, if that&rsquo;s not what you want you need to provide <code>--path vendor/bundle</code> ou <code>--deployment</code> to the first install command (this will create a <code>.bundle/config</code> file to hold the installation path so that consecutives commands will be able to find the gems).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>user@arcanin:~ $ bundle install --deployment
</span></span><span class=line><span class=cl>Fetching gem metadata from https://rubygems.org/.........
</span></span><span class=line><span class=cl>Fetching concurrent-ruby 1.0.5
</span></span><span class=line><span class=cl>Installing concurrent-ruby 1.0.5
</span></span><span class=line><span class=cl>Fetching i18n 0.9.5
</span></span><span class=line><span class=cl>Installing i18n 0.9.5
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl>Fetching jekyll-assets 3.0.11
</span></span><span class=line><span class=cl>Installing jekyll-assets 3.0.11
</span></span><span class=line><span class=cl>Fetching jemoji 0.6.2
</span></span><span class=line><span class=cl>Installing jemoji 0.6.2
</span></span><span class=line><span class=cl>Fetching uglifier 4.1.9
</span></span><span class=line><span class=cl>Installing uglifier 4.1.9
</span></span><span class=line><span class=cl>Bundle complete! <span class=m>9</span> Gemfile dependencies, <span class=m>56</span> gems now installed.
</span></span><span class=line><span class=cl>Bundled gems are installed into <span class=sb>`</span>./vendor/bundle<span class=sb>`</span>
</span></span><span class=line><span class=cl>Post-install message from html-pipeline:
</span></span><span class=line><span class=cl>-------------------------------------------------
</span></span><span class=line><span class=cl>Thank you <span class=k>for</span> installing html-pipeline!
</span></span><span class=line><span class=cl>You must bundle Filter gem dependencies.
</span></span><span class=line><span class=cl>See html-pipeline README.md <span class=k>for</span> more details.
</span></span><span class=line><span class=cl>https://github.com/jch/html-pipeline#dependencies
</span></span><span class=line><span class=cl>-------------------------------------------------
</span></span><span class=line><span class=cl>Post-install message from image_optim:
</span></span><span class=line><span class=cl>Rails image assets optimization is extracted into image_optim_rails gem
</span></span><span class=line><span class=cl>You can safely remove <span class=sb>`</span>config.assets.image_optim <span class=o>=</span> <span class=nb>false</span><span class=sb>`</span> <span class=k>if</span> you are not going to use that gem</span></span></code></pre></div><p>Next i setup jekyll to use this new plugin. Although using <code>bundle</code> some step are optionnal (the gems/plugins list for example), it is IMPERATIVE to add &ldquo;vendor&rdquo; in your exclude list because otherwise you will encounter errors of the weirdest kind like:</p><pre tabindex=0><code>Document &#39;vendor/bundle/ruby/2.5.0/gems/jekyll-3.7.3/lib/site_template/_posts/0000-00-00-welcome-to-jekyll.markdown.erb&#39; does not have a valid date in the YAML front matter.
</code></pre><p>So here is my configuration:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>sass</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>style</span><span class=p>:</span><span class=w> </span><span class=l>compressed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>assets</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gzip</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>plugins</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>img</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>optim</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>jekyll</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>jpegrecompress</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>gems</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>jekyll-assets</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># if you want to use Bootstrap 3.x since jekyll-assets incorrectly try</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># to load boostrap-sass and the author seems to prefer removing it altogether</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># you need to add it manually here:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># - bootstrap-sass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>exclude</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;README.md&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;CHANGELOG.md&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;CNAME&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;Gemfile&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;Gemfile.lock&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>.gitignore</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>.bundle</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>.git</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>vendor</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>user@desktop:~ $ <span class=nv>JEKYLL_ENV</span><span class=o>=</span><span class=nb>local</span> bundle <span class=nb>exec</span> jekyll serve -d /path/to/temporaryroot -V
</span></span><span class=line><span class=cl>user@server:~ $ <span class=nv>JEKYLL_ENV</span><span class=o>=</span>production bundle <span class=nb>exec</span> jekyll build -d /path/to/webroot</span></span></code></pre></div><h3 id=changes>Changes</h3><p>A few changes are needed in your theme/layout to make full use of jekyll-assets.</p><p>1/ The module expects to find assets in a (relatively long) list of predefined locations (assets/css, assets/fonts, assets/images,&mldr;, _assets/*, css, fonts, images, &mldr;).
If you have file in any other location, you should move them, or extend the <code>assets.sources</code> list.</p><p>RQ: the usual css/main.css + _sass/* split doesn&rsquo;t seem to work well with jekyll-assets, all files should be moved in a css/ directory.</p><p>I personnaly choosed to move every css/sass/images/fonts in an <code>_assets</code> subdirectory to match every other &lsquo;special&rsquo; jekyll folders.</p><p>2/ Assets have to be included with a new syntax:</p><pre tabindex=0><code class=language-liquid data-lang=liquid>{% raw %}{% asset main.css %}

{% asset profil.jpg @optim %}{% endraw%}</code></pre><h2 id=layout-optimisation>Layout optimisation</h2><p>A recurring whining of SEO optimisation tools is related to loading of external JS/CSS ressources (being it the &lsquo;main&rsquo; css or extra fonts, scripts..).</p><p>The ideal solution according to thoses tools is to move loading of every css/js at the end of the page, and inline &ldquo;critical&rdquo; css in the block to reduce the post-loading &lsquo;flickering&rsquo;.</p><p>Sample &lsquo;base&rsquo; layout for jekyll:<pre tabindex=0><code class=language-liquid data-lang=liquid>{% raw %}
---
layout: compress
---

&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    {% include head.html %}
    {% asset inline.css @inline %}
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div class=&#34;container&#34;&gt;
      &lt;div class=&#34;row&#34;&gt;
        {% if page.hide_sidebar or site.data.theme.hide_sidebar %}
          &lt;div class=&#34;col-sm-12&#34;&gt;
            {{ content }}
          &lt;/div&gt;
        {% else %}
          &lt;div class=&#34;col-sm-8&#34;&gt;
            {{ content }}
          &lt;/div&gt;
          &lt;div class=&#34;col-sm-4&#34;&gt;
            {% include sidebar.html %}
          &lt;/div&gt;
        {% endif %}
      &lt;/div&gt;
      &lt;div class=&#34;row footer&#34;&gt;
        &lt;div class=&#34;col-sm-12 text-center&#34;&gt;
          {% include footer.html %}
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    {% asset main.css %}
    {% include scripts.html %}
    {% include fonts.html %}
  &lt;/body&gt;
&lt;/html&gt;
{% endraw%}</code></pre></p><h2 id=conclusion>Conclusion</h2><p>After all this you should high-score PSI and other !</p></article><hr><nav id=timenav><div id=previnsection><h3>Older</h3><article class=post-link><header><h1><a href=/blog/2018/04/16/blog-nginx/>Upgrading the blog, day 1</a></h1><p>A year has past since the beginning of this little experiment, and some results are already showing:
i&rsquo;m not very prolific ^^ i&rsquo;m becoming more and more grumpy i don&rsquo;t like my blog&rsquo;s setup (but didn&rsquo;t find better for now) . So yeah, new year was 4 month ago and still nothing new here, my article on bind, dnssec and knot hasn&rsquo;t moved further, but work-related issues send me back here to make some experiments, our SEO consultants where reportings issues on our client&rsquo;s website and where in need of informations.</p></article></div><div id=nextinsection><h3>Newer</h3><article class=post-link><header><h1><a href=/blog/2018/04/22/freebsd-isc-dhcpv6/>FreeBSD DHCPv6</a></h1><p>In FreeBSD Setup i detailed the use of KAME&rsquo;s dhcp client to authentify and request an IPv6 block to be routed onto the server.
However as it seem this client has a tendancy to misbehave and trigger the hosting provider DOS defense mechanism (mainly rebooting the serveur after disabling dhcp service autorisations, not fun).
While checking around with friend it seems i wasn&rsquo;t the first one hit by this and that the solution was to switch over to ISC&rsquo;s dhcp service, with a little twist (freebsd package for isc-dhcp doesn&rsquo;t include an init script for dhcpv6).</p></article></div></nav></div></main><footer><div>©2022. Built with <a href=https://gohugo.com/>Hugo</a> custom layout loosely based on <a href=https://github.com/ellekasai/shiori>Jekyll Shiori Theme</a>.</div><div><p>Using: <a href=https://www.w3.org/html/logo/><img src=https://www.w3.org/html/logo/badge/html5-badge-h-css3.png alt="HTML5 Powered with CSS3 / Styling" title="HTML5 Powered with CSS3 / Styling" width=33 height=16></a> <a href="https://validator.w3.org/check?uri=/">Validate</a></p></div></footer></body></html>