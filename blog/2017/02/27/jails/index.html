<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Setting up jails | Silmaril's Blog</title><meta property="og:title" content="Silmaril's Blog"><link rel=stylesheet href=/main.min.css><link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Prompt:wght@700&display=swap" rel=stylesheet></head><body class=page><header class=top-header><nav><ul class=top-nav><li class=top-nav__logo><a href=/>Silmaril's Blog</a></li><li class=top-nav__link><a href=/pages/about>About</a><li class=top-nav__link><a href=/blog/>Archives</a><li class=top-nav__link><a href=/pages/links>Links</a></ul></nav></header><main class=main-content><aside><h1>Author</h1><div class=profil><h4><a href=/pages/about/>Benoit Plessis</a></h4><img src=/images/profil.png width=100 height=100 alt="Author Profil"><p>System & Network Engineer - France</p></div><p><small>Simple sysadmin notes and thought on the world&mldr; Yeah no just kidding, some less than special rant and diary.</small></p><nav id=social><ul><li><a href=mailto:benoit@plessis.info>Email Contact</a></li><li><a href="https://twitter.com/silmaril34?ref_src=twsrc%5Etfw" class=twitter-follow-button data-show-count=false>Follow @silmaril34</a><script async src=https://platform.twitter.com/widgets.js></script></li><li><a class=github-button href=https://github.com/bplessis data-color-scheme="no-preference: light; light: light; dark: dark;" data-size=large aria-label="Follow @bplessis on GitHub">Follow @bplessis</a><script async defer src=https://buttons.github.io/buttons.js></script></li></ul></nav></aside><div class=page-content><article id=content><p>The main idea of this new setup is to try and isolate services for the main host, which should be only used for management.</p><p>So every service will be run in it&rsquo;s own context, known as <em>jails</em> in the Free/Net/OpenBSD lingua.</p><p>However a few helping services on the host might be usefull, for DNS resolving, log collection, &mldr;</p><h1 id=service-ip>Service IP</h1><p>Since i don&rsquo;t own a lot of IPv4 public adresses, some a private IPv4 network will be used for accessing services in this network familly, and some NAT will have to be set.</p><p>However online is being generous with IPv6 block so i can use a direct IPv6 connection.</p><p>To do so, i&rsquo;ll use a dedicated loopback address, by adding the following to the <em>rc.conf</em> file:<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>cloned_interfaces</span><span class=o>=</span><span class=s2>&#34;lo1&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>ifconfig_lo1</span><span class=o>=</span><span class=s2>&#34;up 10.0.2.1/24&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>ifconfig_lo1_ipv6</span><span class=o>=</span><span class=s2>&#34;inet6 2001:d8:1:101:0:0:1/64&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># setting syslog to listen on the internal loopback address and allowing inbound from the jail net:</span>
</span></span><span class=line><span class=cl><span class=nv>syslogd_flags</span><span class=o>=</span><span class=s2>&#34;-a 10.0.2.1/24 -b 10.0.2.1 -C&#34;</span></span></span></code></pre></div></p><p>The pf configuration from the previous post will have to be modified, to add so outbound NAT, and allow IPv6 outbound trafic for the jails:<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># Define variable for jails networks</span>
</span></span><span class=line><span class=cl><span class=nv>jail_net</span><span class=o>=</span><span class=s2>&#34;10.0.2.0/24&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>jail_net6</span><span class=o>=</span><span class=s2>&#34;2001:d8:1:101::/64&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=c1># 4: Translation</span>
</span></span><span class=line><span class=cl> <span class=c1># Translate IPv4 adresses belonging to the private jail net on the public interface</span>
</span></span><span class=line><span class=cl> nat on <span class=nv>$if</span> from <span class=nv>$jail_net</span> to any -&gt; <span class=nv>$if</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=c1># 5 Filtering</span>
</span></span><span class=line><span class=cl> <span class=c1># default outbound</span>
</span></span><span class=line><span class=cl> <span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl> <span class=c1># Allow ipv6 outbound packet from the jail ipv6 network</span>
</span></span><span class=line><span class=cl> pass out quick on <span class=nv>$if</span> from <span class=nv>$jail_net6</span> to any</span></span></code></pre></div></p><p>Reloading the pf configuration is done by :<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@frb:~ <span class=c1># pfctl -nf /etc/pf.conf</span></span></span></code></pre></div></p><h1 id=dns-resolver>DNS Resolver</h1><p>FreeBSD use the unbound resolver by default, by the default configuration won&rsquo;t match our need. By default unbound will bind on 127.0.0.1:53 but we need him to listen on our jails &lsquo;gateway&rsquo;.</p><p>So we add a <em>/etc/unbound/conf.d/interface.conf</em> with the following content:<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>server:
</span></span><span class=line><span class=cl>        <span class=c1># Listen to loopback / jails loopback address</span>
</span></span><span class=line><span class=cl>        interface: 127.0.0.1
</span></span><span class=line><span class=cl>        interface: 10.0.2.1
</span></span><span class=line><span class=cl>        interface: 2001:d8:1:101::1
</span></span><span class=line><span class=cl>        access-control: 10.0.0.0/8 allow
</span></span><span class=line><span class=cl>        access-control: 2001:bc8:1:100::/56 allow</span></span></code></pre></div></p><p>This forces unbound to listen on all the IP addresses we need, and all dns query from the jails.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@frb:~ <span class=c1># service local_unbound restart</span></span></span></code></pre></div><h1 id=setting-up-ezjail>Setting-up EzJail</h1><p>As i&rsquo;m no FreeBSD expert, even a newbie, creating jails manually from scratch wasn&rsquo;t an option i looked forward to ;) so in search to alternatives EzJail looked interesting, being integrated with ZFS and &ldquo;space-friendly&rdquo;.</p><p>EzJail works by initialising a shared &ldquo;basejail&rdquo; which is later on null-mounted (FreeBSD&rsquo;s version of linux &lsquo;bind&rsquo;) in each jails /basejail directory. and a &ldquo;newjail&rdquo; directory which is the base template of all futur jails.</p><p>You can also use &ldquo;flavours&rdquo; to pre-set some files on the jails, be wary of the permissions of files and directory on thoses flavors however, they will be replicated on the jails !</p><p>My flavor for example automatically set the syslog.conf to log remotly on the host, the resolver, disable sendmail, etc &mldr;</p><p>A few options are necessary on the <em>/usr/local/etc/ezjail.conf</em> to activate the ZFS options:<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># Setting this to YES will start to manage the basejail and newjail in ZFS</span>
</span></span><span class=line><span class=cl><span class=nv>ezjail_use_zfs</span><span class=o>=</span><span class=s2>&#34;YES&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Setting this to YES will manage ALL new jails in their own zfs</span>
</span></span><span class=line><span class=cl><span class=nv>ezjail_use_zfs_for_jails</span><span class=o>=</span><span class=s2>&#34;YES&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># The name of the ZFS ezjail should create jails on, it will be mounted at the ezjail_jaildir</span>
</span></span><span class=line><span class=cl><span class=nv>ezjail_jailzfs</span><span class=o>=</span><span class=s2>&#34;zroot/ezjail&#34;</span></span></span></code></pre></div></p><h1 id=creating-the-first-jail>Creating the first Jail</h1><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@frb:~ <span class=c1># ezjail-admin create ns3 &#39;lo1|10.0.2.1,lo1|2001:d8:1:101::1&#39;</span>
</span></span><span class=line><span class=cl>/usr/jails/ns3/.
</span></span><span class=line><span class=cl>/usr/jails/ns3/./etc
</span></span><span class=line><span class=cl>/usr/jails/ns3/./etc/rc.conf
</span></span><span class=line><span class=cl>/usr/jails/ns3/./etc/rc.d
</span></span><span class=line><span class=cl>/usr/jails/ns3/./etc/rc.d/ezjail.mine
</span></span><span class=line><span class=cl>/usr/jails/ns3/./etc/periodic.conf
</span></span><span class=line><span class=cl>/usr/jails/ns3/./etc/syslog.conf
</span></span><span class=line><span class=cl>/usr/jails/ns3/./etc/resolv.conf
</span></span><span class=line><span class=cl>/usr/jails/ns3/./etc/crontab
</span></span><span class=line><span class=cl><span class=m>8</span> blocks
</span></span><span class=line><span class=cl>find: /usr/jails/ns3/pkg/: No such file or directory
</span></span><span class=line><span class=cl>Warning: Some services already seem to be listening on all IP, <span class=o>(</span>including 10.10.2.20<span class=o>)</span>
</span></span><span class=line><span class=cl>  This may cause some confusion, here they are:
</span></span><span class=line><span class=cl>root     master     <span class=m>978</span>   <span class=m>13</span> tcp4   *:25                  *:*
</span></span><span class=line><span class=cl>root     ntpd       <span class=m>884</span>   <span class=m>20</span> udp6   *:123                 *:*
</span></span><span class=line><span class=cl>root     ntpd       <span class=m>884</span>   <span class=m>21</span> udp4   *:123                 *:*
</span></span><span class=line><span class=cl>root     dhcp6c     <span class=m>770</span>   <span class=m>4</span>  udp6   *:546                 *:*</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@frb:~ <span class=c1># ezjail-admin start ns3</span>
</span></span><span class=line><span class=cl>root@frb:~ <span class=c1># ezjail-admin console ns3</span>
</span></span><span class=line><span class=cl>root@ns3:~ <span class=c1>#</span></span></span></code></pre></div><p>Enjoy your micro-vm/container/whatever ;)</p><p>Update from august:</p><h1 id=updating-jails>Updating Jails</h1><p>To the latest patch:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@frb:~ <span class=c1># ezjail-admin -u</span></span></span></code></pre></div><p>Upgrading to the current host version (need to specify the &lsquo;source&rsquo; version):<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@frb:~ <span class=c1># ezjail-admin -U -s 11.0-RELEASE</span></span></span></code></pre></div></p></article><hr><nav id=timenav><div id=previnsection><h3>Older</h3><article class=post-link><header><h1><a href=/blog/2017/02/19/firewall-pf/>Firewalling: PF</a></h1><p>So, now we have some basis of a working system.
Time to think about protecting if, while the Internet is the place to be it&rsquo;s also a kind of a bad place, moreover when you&rsquo;re in the middle of a known hosting company.
Firewalling So, we have to play with FreeBSD firewall solution: PF, as in Packet Filter.
Configuring So first thing is to setup a few rules in the /etc/pf.</p></article></div><div id=nextinsection><h3>Newer</h3><article class=post-link><header><h1><a href=/blog/2017/05/05/Poudriere/>Poudriere</a></h1><p>In some cases you might need to use some customisation over the standard pre-built packages repository. Two choices there: you can either manually build them using the ports system on each of your jails/servers, or you can make a custom pkg repository with your build options.
This is what i will show here, using the poudriere build system, a creation by the same author of pkg, bapt, a good guy (yes yes ;) ) who has coped with me during many FreeBSD rants (well he wasn&rsquo;t the only one, thanks Keltia , nerzhul, renchap and others for your precious help).</p></article></div></nav></div></main><footer><div>©2022. Built with <a href=https://gohugo.com/>Hugo</a> custom layout loosely based on <a href=https://github.com/ellekasai/shiori>Jekyll Shiori Theme</a>.</div><div><p>Using: <a href=https://www.w3.org/html/logo/><img src=https://www.w3.org/html/logo/badge/html5-badge-h-css3.png alt="HTML5 Powered with CSS3 / Styling" title="HTML5 Powered with CSS3 / Styling" width=33 height=16></a> <a href="https://validator.w3.org/check?uri=/">Validate</a></p></div></footer></body></html>