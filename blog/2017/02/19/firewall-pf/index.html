<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Firewalling: PF | Silmaril's Blog</title><meta property="og:title" content="Silmaril's Blog"><link rel=stylesheet href=/main.min.css><meta name=description content><meta name=author content="Benoit Plessis"><link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Prompt:wght@700&display=swap" rel=stylesheet></head><body class=page><header class=top-header><nav><ul class=top-nav><li class=top-nav__logo><a href=/>Silmaril's Blog</a></li><li class=top-nav__link><a href=/pages/about>About</a><li class=top-nav__link><a href=/blog/>Archives</a><li class=top-nav__link><a href=/pages/links>Links</a></ul></nav></header><main class=main-content><aside><h1>Author</h1><div class=profil><h4><a href=/pages/about/>Benoit Plessis</a></h4><img src=/images/profil.png width=100 height=100 alt="Author Profil"><p>System & Network Engineer - France</p></div><p><small>Simple sysadmin notes and thought on the world… Yeah no just kidding, some less than special rant and diary.</small></p><nav id=social><ul><li><a href=mailto:benoit@plessis.info class="social-button email-button">Email Contact</a></li><li><a href="https://twitter.com/silmaril34?ref_src=twsrc%5Etfw" class="social-button twitter-follow-button">Follow @silmaril34</a></li><li><a href=https://github.com/bplessis class="social-button github-follow-button" aria-label="Follow @bplessis on GitHub">Follow @bplessis</a></li></ul></nav></aside><div class=page-content><article id=content><p>So, now we have some basis of a working system.</p><p>Time to think about protecting if, while the Internet is the place to be it&rsquo;s also a kind of a bad place, moreover when you&rsquo;re in the middle of a known hosting company.</p><h1 id=firewalling>Firewalling</h1><p>So, we have to play with FreeBSD firewall solution: <em>PF</em>, as in <em>Packet Filter</em>.</p><h2 id=configuring>Configuring</h2><p>So first thing is to setup a few rules in the <em>/etc/pf.conf</em> file:</p><pre><code>pub=&quot;192.0.2.1&quot; # Host public IPv4 address
pub6=&quot;2001:db8:1::1&quot; # Host public IPv6 address

if=&quot;bge0&quot;

# Rules must be in order: options, normalization, queueing, translation, filtering
# 1: options

set block-policy return
set skip on lo
scrub in

table &lt;sshguard&gt; persist

# 2: Normalization

# 3: Queueing

# 4: Translation ?

# 5 Filtering
# default outbound
pass out quick on $if from $pub to any
pass out quick on $if from $pub6 to any

# Filter brut-forcer
block in quick proto tcp from &lt;sshguard&gt;
block in log on $if

# ICMP v4/v6
pass in quick on $if inet proto icmp from any to any
pass in quick on $if inet6 proto ipv6-icmp from any to any

# DHCPv6
pass in quick on $if inet6 proto udp from any to bge0 port 546 keep state

# ssh/mosh on the host machine
pass in quick on $if proto tcp from any to $pub port ssh
pass in quick on $if proto udp from any to $pub port 60000:60100
pass in quick on $if proto tcp from any to $pub6 port ssh
pass in quick on $if proto udp from any to $pub6 port 60000:60100
</code></pre><h2 id=starting>Starting</h2><p>Then a few line in the <em>/etc/rc.conf</em> are needed to automatically activate the firewall on start:</p><pre><code>pf_enable=&quot;YES&quot;
pf_rules=&quot;/etc/pf.conf&quot;
pflog_enable=&quot;YES&quot;
</code></pre><p>Then it&rsquo;s just a matter of starting the service as usual.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@frb:~ <span class=c1># service pf start</span>
</span></span><span class=line><span class=cl>root@frb:~ <span class=c1># service pflogd start</span></span></span></code></pre></div><h2 id=updating>Updating</h2><p>Whenever you need to update the pf ruleset, you just have to edit the <em>/etc/pf.conf</em> file, and then test it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@frb:~ <span class=c1># pfctl -nf /etc/pf.conf</span></span></span></code></pre></div><p>And update it with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@frb:~ <span class=c1># pfctl -f /etc/pf.conf</span></span></span></code></pre></div><h1 id=sshguard>sshguard</h1><p>Having a general firewall is good, it could be usefull to do some automated log analysis and defense. For that you can use the same mollyguard tool as under linux system, or you can use <code>sshguard</code> who has an native <code>pf</code> integration:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@frb:~ <span class=c1># pkg install sshguard-pf</span>
</span></span><span class=line><span class=cl>Updating FreeBSD repository catalogue...
</span></span><span class=line><span class=cl><span class=o>[</span>test<span class=o>]</span> Fetching meta.txz: 100%    <span class=m>944</span> B   0.9kB/s    00:01
</span></span><span class=line><span class=cl><span class=o>[</span>test<span class=o>]</span> Fetching packagesite.txz: 100%    <span class=m>6</span> MiB   5.9MB/s    00:01
</span></span><span class=line><span class=cl>Processing entries: 100%
</span></span><span class=line><span class=cl>FreeBSD repository update completed. <span class=m>25860</span> packages processed.
</span></span><span class=line><span class=cl>The following <span class=m>1</span> package<span class=o>(</span>s<span class=o>)</span> will be affected <span class=o>(</span>of <span class=m>0</span> checked<span class=o>)</span>:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>New packages to be INSTALLED:
</span></span><span class=line><span class=cl>        sshguard-pf: 1.7.0_1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Number of packages to be installed: <span class=m>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>The process will require <span class=m>2</span> MiB more space.
</span></span><span class=line><span class=cl><span class=m>320</span> KiB to be downloaded.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Proceed with this action? <span class=o>[</span>y/N<span class=o>]</span>: y
</span></span><span class=line><span class=cl><span class=o>[</span>frb<span class=o>]</span> Fetching sshguard-pf-1.7.0_1.txz: 100%  <span class=m>320</span> KiB 327.7kB/s    00:01
</span></span><span class=line><span class=cl>Checking integrity... <span class=k>done</span> <span class=o>(</span><span class=m>0</span> conflicting<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>frb<span class=o>]</span> <span class=o>[</span>1/1<span class=o>]</span> Installing sshguard-pf-1.7.0_1...
</span></span><span class=line><span class=cl><span class=o>[</span>frb<span class=o>]</span> <span class=o>[</span>1/1<span class=o>]</span> Extracting sshguard-pf-1.7.0_1: 100%
</span></span><span class=line><span class=cl>Message from sshguard-pf-1.7.0_1:
</span></span><span class=line><span class=cl><span class=c1>##########################################################################</span>
</span></span><span class=line><span class=cl>  Sshguard installed successfully.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  To activate or configure PF see http://www.sshguard.net/docs/setup/firewall/pf/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  You can start sshguard as a daemon by using the
</span></span><span class=line><span class=cl>  rc.d script installed at /usr/local/etc/rc.d/sshguard .
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  See sshguard<span class=o>(</span>8<span class=o>)</span> and http://www.sshguard.net/docs/setup <span class=k>for</span> additional info.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  Please note that a few rc script parameters have been renamed to
</span></span><span class=line><span class=cl>  better reflect the documentation:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  sshguard_safety_thresh -&gt; sshguard_danger_thresh
</span></span><span class=line><span class=cl>  sshguard_pardon_min_interval -&gt; sshguard_release_interval
</span></span><span class=line><span class=cl>  sshguard_prescribe_interval -&gt; sshguard_reset_interval
</span></span><span class=line><span class=cl><span class=c1>##########################################################################</span></span></span></code></pre></div><p>Next step is simply activating the service in <em>rc.conf</em>, manually or by using <code>sysrc</code>:<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@frb:~ <span class=c1># sysrc sshguard_enable=&#34;YES&#34;</span></span></span></code></pre></div></p><p>And starting up the service:<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@frb:~ <span class=c1># service sshguard start</span></span></span></code></pre></div></p><p>You can then look for sshguard message in <em>/var/log/message</em> and inspect the deny table using:<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@frb:~ <span class=c1># pfctl -t sshguard -T show</span></span></span></code></pre></div></p><p>NB setting up a few IPs addresses in <em>/usr/local/etc/sshguard.whitelist</em> might be a good idea.</p></article><hr><nav id=timenav><div id=previnsection><h3>Older</h3><article class=post-link><header><h1><a href=/blog/2017/02/14/freebsd-setup/>Configuration Time</a></h1><p>Hi there,
Taking over where i left before, so now i do have a fresh and shiny new machine, time to set it up.
The Base System FreeBSD contrarious to linux system is separated into two main part, the main part is the &ldquo;base system&rdquo;, basically it&rsquo;s what FreeBSD is, and is released and updated as a whole.
To keep the base system up to date we need to use the freebsd-update utility.</p></article></div><div id=nextinsection><h3>Newer</h3><article class=post-link><header><h1><a href=/blog/2017/02/27/jails/>Setting up jails</a></h1><p>The main idea of this new setup is to try and isolate services for the main host, which should be only used for management.
So every service will be run in it&rsquo;s own context, known as jails in the Free/Net/OpenBSD lingua.
However a few helping services on the host might be usefull, for DNS resolving, log collection, &mldr;
Service IP Since i don&rsquo;t own a lot of IPv4 public adresses, some a private IPv4 network will be used for accessing services in this network familly, and some NAT will have to be set.</p></article></div></nav></div></main><footer><div>©2023. Built with <a href=https://gohugo.com/>Hugo</a> custom layout loosely based on <a href=https://github.com/ellekasai/shiori>Jekyll Shiori Theme</a>.</div><div><p>Using: <a href=https://www.w3.org/html/logo/><img src=https://www.w3.org/html/logo/badge/html5-badge-h-css3.png alt="HTML5 Powered with CSS3 / Styling" title="HTML5 Powered with CSS3 / Styling" width=33 height=16></a> <a href="https://validator.w3.org/check?uri=/">Validate</a></p></div></footer></body></html>