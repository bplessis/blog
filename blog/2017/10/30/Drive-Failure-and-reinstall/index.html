<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Drive Failure and reinstall | Silmaril's Blog</title><meta property="og:title" content="Silmaril's Blog"><link rel=stylesheet href=/main.min.css><meta name=description content><meta name=author content="Benoit Plessis"><link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Prompt:wght@700&display=swap" rel=stylesheet></head><body class=page><header class=top-header><nav><ul class=top-nav><li class=top-nav__logo><a href=/>Silmaril's Blog</a></li><li class=top-nav__link><a href=/pages/about>About</a><li class=top-nav__link><a href=/blog/>Archives</a><li class=top-nav__link><a href=/pages/links>Links</a></ul></nav></header><main class=main-content><aside><h1>Author</h1><div class=profil><h4><a href=/pages/about/>Benoit Plessis</a></h4><img src=/images/profil.png width=100 height=100 alt="Author Profil"><p>System & Network Engineer - France</p></div><p><small>Simple sysadmin notes and thought on the world… Yeah no just kidding, some less than special rant and diary.</small></p><nav id=social><ul><li><a href=mailto:benoit@plessis.info class="social-button email-button">Email Contact</a></li><li><a href="https://twitter.com/silmaril34?ref_src=twsrc%5Etfw" class="social-button twitter-follow-button">Follow @silmaril34</a></li><li><a href=https://github.com/bplessis class="social-button github-follow-button" aria-label="Follow @bplessis on GitHub">Follow @bplessis</a></li></ul></nav></aside><div class=page-content><article id=content><p>Hi,</p><p>This weekend was one of thoses weekend &mldr; Sunday morning while trying to destroy an unused jail i got a zfs warning: &ldquo;pool is degraded&rdquo;.</p><p>As it turn out i was missing a drive in my zfs mirror setup, so heck .. no fun.</p><p>After a few email with the hosting company they recommended i migrate over a new server, which is running ok if you&rsquo;re reading this ;).</p><p>I needed to make a backup of the old system, not wanting to reinstall everything from scratch, i dig a bit and made two &ldquo;files&rdquo; from the original server:</p><p>1/ a backup of the geometry:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@frb:~# gpart backup ada0 &gt; /var/tmp/backup.geom</span></span></code></pre></div><p>which gave me something like that:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>  GPT <span class=m>152</span>
</span></span><span class=line><span class=cl>  <span class=m>1</span>   freebsd-boot         <span class=m>40</span>       <span class=m>1024</span>
</span></span><span class=line><span class=cl>  <span class=m>2</span>   freebsd-swap       <span class=m>2048</span>    <span class=m>4194304</span> swap0
</span></span><span class=line><span class=cl>  <span class=m>3</span>   freebsd-zfs    <span class=m>4196352</span> <span class=m>1949327360</span> zfs0</span></span></code></pre></div><p>2/ a backup of the filesystem:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@frb:~# zfs snapshot -r zroot@sunday_20171029
</span></span><span class=line><span class=cl>root@frb:~# zfs send -R zroot@sunday_20171029 &gt; /var/tmp/backup.zfs</span></span></code></pre></div><p>And voila ! i just had to put this two file over an ftp server.</p><p>(well actually the first time i tried using the -D option of zfs send to further shrink the stream, as it turn out it wasn&rsquo;t a great idea, the recv method didn&rsquo;t like it).</p><p>The new serveur was made available at around 20:00 sunday evening, thanks to some limitation in the cloud tools provided i had to start an automated pre-scripted install before being able to &ldquo;hack over&rdquo; the hardware. So i did started the process just before going over to the movie (latest Blade Runner, fine by the way but so slow &mldr; ).</p><p>So after the movie, the server was up and running and i only had to &mldr; reboot it in rescue mode. The rescue mode is a PXE-booted environment that come in multiple &ldquo;flavor&rdquo;, including three FreeBSD version, that allow an ssh acces and will allow the reset everything easily.</p><p>When the freebsd/rescue is booted /tmp is mounted as a tmpfs, lucky me the memory available on the server is greated that the size of the zfs backup stream so i downloaded everything over it.</p><p>The drives where re-partitionned using:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@frb:~# gpart restore -F -l ada0 &lt; backup.geom
</span></span><span class=line><span class=cl>root@frb:~# gpart restore -F ada1 &lt; backup.geom
</span></span><span class=line><span class=cl>root@frb:~# gpart modify -i <span class=m>2</span> -l swap1 ada1
</span></span><span class=line><span class=cl>root@frb:~# gpart modify -i <span class=m>3</span> -l zfs1 ada1</span></span></code></pre></div><p>Boot code was installed using:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@frb:~# gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i <span class=m>1</span> ada0
</span></span><span class=line><span class=cl>root@frb:~# gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i <span class=m>1</span> ada1</span></span></code></pre></div><p>Apparently the swap took care of itself ;)</p><p>The <em>only</em> thing left was .. the file system, this get a bit tricky and it took quite a bit to get it done right but the process should be only:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@frb:~# zpool create zroot mirror gpt/zfs0 gpt/zfs1
</span></span><span class=line><span class=cl>root@frb:~# zfs recv zroot &lt; backup.zfs
</span></span><span class=line><span class=cl>root@frb:~# zpool <span class=nb>set</span> <span class=nv>bootfs</span><span class=o>=</span>zroot/ROOT/default zroot</span></span></code></pre></div><p>If, like me, you had to restart the server in rescue mode because the first boot didn&rsquo;t get you there, there is a few interesting command to consider:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@frb:~# zpool import -R /mnt zroot
</span></span><span class=line><span class=cl>root@frb:~# mount -t zfs zroot/ROOT/default /altroot</span></span></code></pre></div><p>anyway, short things short the new server was up and running after only a 15 minutes service interruption !</p></article><hr><nav id=timenav><div id=previnsection><h3>Older</h3><article class=post-link><header><h1><a href=/blog/2017/05/05/Poudriere/>Poudriere</a></h1><p>In some cases you might need to use some customisation over the standard pre-built packages repository. Two choices there: you can either manually build them using the ports system on each of your jails/servers, or you can make a custom pkg repository with your build options.
This is what i will show here, using the poudriere build system, a creation by the same author of pkg, bapt, a good guy (yes yes ;) ) who has coped with me during many FreeBSD rants (well he wasn&rsquo;t the only one, thanks Keltia , nerzhul, renchap and others for your precious help).</p></article></div><div id=nextinsection><h3>Newer</h3><article class=post-link><header><h1><a href=/blog/2018/04/16/blog-nginx/>Upgrading the blog, day 1</a></h1><p>A year has past since the beginning of this little experiment, and some results are already showing:
i&rsquo;m not very prolific ^^ i&rsquo;m becoming more and more grumpy i don&rsquo;t like my blog&rsquo;s setup (but didn&rsquo;t find better for now) . So yeah, new year was 4 month ago and still nothing new here, my article on bind, dnssec and knot hasn&rsquo;t moved further, but work-related issues send me back here to make some experiments, our SEO consultants where reportings issues on our client&rsquo;s website and where in need of informations.</p></article></div></nav></div></main><footer><div>©2022. Built with <a href=https://gohugo.com/>Hugo</a> custom layout loosely based on <a href=https://github.com/ellekasai/shiori>Jekyll Shiori Theme</a>.</div><div><p>Using: <a href=https://www.w3.org/html/logo/><img src=https://www.w3.org/html/logo/badge/html5-badge-h-css3.png alt="HTML5 Powered with CSS3 / Styling" title="HTML5 Powered with CSS3 / Styling" width=33 height=16></a> <a href="https://validator.w3.org/check?uri=/">Validate</a></p></div></footer></body></html>