<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Setting up an HA LoadBalancer with haproxy 2.x and exabgp 4.x | Silmaril's Blog</title><meta property="og:title" content="Silmaril's Blog"><link rel=stylesheet href=../../../../../main.min.css><link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Prompt:wght@700&display=swap" rel=stylesheet></head><body class=page><header class=top-header><nav><ul class=top-nav><li class=top-nav__logo><a href=../../../../../>Silmaril's Blog</a></li><li class=top-nav__link><a href=../../../../../pages/about>About</a><li class=top-nav__link><a href=../../../../../blog/>Archives</a><li class=top-nav__link><a href=../../../../../pages/links>Links</a></ul></nav></header><main class=main-content><aside><h1>Author</h1><div class=profil><h4><a href=../../../../../pages/about/>Benoit Plessis</a></h4><img src=../../../../../images/profil.png width=100 height=100 alt="Author Profil"><p>System & Network Engineer - France</p></div><p><small>Simple sysadmin notes and thought on the world&mldr; Yeah no just kidding, some less than special rant and diary.</small></p><nav id=social><ul><li><a href=mailto:benoit@plessis.info>Email Contact</a></li><li><a href="https://twitter.com/silmaril34?ref_src=twsrc%5Etfw" class=twitter-follow-button data-show-count=false>Follow @silmaril34</a><script async src=https://platform.twitter.com/widgets.js></script></li><li><a class=github-button href=https://github.com/bplessis data-color-scheme="no-preference: light; light: light; dark: dark;" data-size=large aria-label="Follow @bplessis on GitHub">Follow @bplessis</a><script async defer src=https://buttons.github.io/buttons.js></script></li></ul></nav></aside><div class=page-content><article id=content><p>A few time ago i started a project of replacing our proprietary load-balancing solution. As i already previously used haproxy for the task i leaned over re-using this formidable software.
However i did not wanted to use VRRP for HA-ing the lot, so there is the story of how i did this.</p><h1 id=schema>Schema</h1><p>Here is a quick schematic depicting the final configuration:</p><p><img src=global_schematic.png alt="Global Schematic"></p><h1 id=setting-up-haproxy>Setting up HAProxy</h1><p>First things first, you&rsquo;ll need to add haproxy (at least 2.0 to use the included process manager to handle the dataplaneapi).</p><p>I used the almost official <a href=https://haproxy.debian.net>Debian/Ubuntu HAProxy packages</a> page to add a recent enough haproxy onto buster.</p><p>Configuration of haproxy is not really in the context of this article, but some points shown below need special care, a full configuration example is available <a href=haproxy.cfg>here</a>.</p><h2 id=setting-up-the-dataplaneapi>Setting up the DataplaneAPI</h2><p>The idea is to have as little configuration redundancy as possible, so in order for exabgp to publish services IP we will need to extract them one way or another. The solution that caught my eye was the newly open-sourced DataPlaneAPI module for haproxy (originaly limited to HAProxy Enterprise). This tool handle configuration parsing and publishing over a REST service.</p><p>You can download dataplaneapi from <a href=https://github.com/haproxytech/dataplaneapi>HAProxy Tech GitHub</a></p><p>Once the binary stored on you server, you&rsquo;ll need to add two configurations blocks in your haproxy.cfg, one /userlist/ for controlling access to the API and one /program/ for starting the module:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>userlist controller
</span></span><span class=line><span class=cl>  user dataplaneapi insecure-password &lt;<span class=nb>set</span> a password&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>program api
</span></span><span class=line><span class=cl>  <span class=nb>command</span> /usr/local/bin/dataplaneapi --host 127.0.0.1 --port <span class=m>5555</span> --haproxy-bin /usr/sbin/haproxy --config-file /etc/haproxy/haproxy.cfg --reload-cmd <span class=s2>&#34;systemctl reload haproxy&#34;</span> --reload-delay <span class=m>5</span> --userlist controller</span></span></code></pre></div><h2 id=setting-up-frontends-with-monitoring>Setting up frontends with monitoring</h2><p>You&rsquo;ll also need to publish an healthcheck url on your frontends, like that</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>frontend _frontend_ex1
</span></span><span class=line><span class=cl>  mode http
</span></span><span class=line><span class=cl>  <span class=nb>bind</span> 192.0.2.30:80
</span></span><span class=line><span class=cl>  <span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl>  monitor-uri /_healthcheck
</span></span><span class=line><span class=cl>  monitor-net 127.0.0.0/8</span></span></code></pre></div><h2 id=service-ip>Service IP</h2><p>There is a little catch in this setup, service IP won&rsquo;t be dynamically added to one of the network interface, so you&rsquo;ll need to add thoses IP(s) to the loopback interface. I real life scenario the full setup is deployed by a confmgmt service (opscode-chef) but you might want to add the addresses in the network scripts for them to be up on boot.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@localhost# ip addr add 192.0.2.30/32 dev lo</span></span></code></pre></div><h1 id=setting-up-haexabgp>Setting up HA/exabgp</h1><p>Now that the service is avaible, time to make it highly !</p><p>For this part we will be using <a href=https://github.com/Exa-Networks/exabgp>Exabgp 4.0+</a>, I used debian/buster package without issues, your mileage may vary.</p><p>The idea is to make BGP session with your core BGP platform to publish /32 routes for each frontend, for this you&rsquo;ll need BGP-aware router (duh) and a BGP-aware speaker on your server (this will be exabgp&rsquo;s role).</p><h2 id=configuration-exabgpconf>Configuration exabgp.conf</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>process watch-haproxy <span class=o>{</span>
</span></span><span class=line><span class=cl>    run /usr/bin/python3 /usr/local/sbin/healthcheck-haproxy.py -s --api-password &lt;<span class=nb>set</span> a password&gt; --cmd <span class=s2>&#34;curl --fail --verbose --max-time 2 http://%s/_healthcheck&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    encoder text<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>template <span class=o>{</span>
</span></span><span class=line><span class=cl>    neighbor core-bgp <span class=o>{</span>
</span></span><span class=line><span class=cl>        router-id 192.0.2.5<span class=p>;</span>
</span></span><span class=line><span class=cl>        local-address 192.0.2.5<span class=p>;</span>
</span></span><span class=line><span class=cl>        local-as 65512<span class=p>;</span>
</span></span><span class=line><span class=cl>        peer-as 65530<span class=p>;</span>
</span></span><span class=line><span class=cl>        family <span class=o>{</span>
</span></span><span class=line><span class=cl>        	ipv4 unicast<span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        api services <span class=o>{</span>
</span></span><span class=line><span class=cl>            processes <span class=o>[</span> watch-haproxy <span class=o>]</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>neighbor 192.0.2.2 <span class=o>{</span>
</span></span><span class=line><span class=cl>    inherit core-bgp<span class=p>;</span>
</span></span><span class=line><span class=cl>    description <span class=s2>&#34;r-1&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>neighbor 192.0.2.3 <span class=o>{</span>
</span></span><span class=line><span class=cl>    inherit core-bgp<span class=p>;</span>
</span></span><span class=line><span class=cl>    description <span class=s2>&#34;r-2&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></div><p>PS: This is more of a manual optimized configuration, when deploying with configuration management I ended with a <a href=exabgp.conf>&ldquo;flattened&rdquo;</a> configuration.</p><h2 id=configuration-bgp-router>Configuration BGP Router</h2><p>This part will highly depend on your network&rsquo;s technology, you&rsquo;ll need to setup eBGP links with your LB hosts, I also added a few safeguard with an empty export policy (exabgp doesn&rsquo;t need info from the routing in my configuration) and an import policy that allow only /32 routes over my network:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>set</span> protocols bgp group lb <span class=nb>type</span> external
</span></span><span class=line><span class=cl><span class=nb>set</span> protocols bgp group lb import bgp_filter_exabgp
</span></span><span class=line><span class=cl><span class=nb>set</span> protocols bgp group lb <span class=nb>export</span> bgp_export_none
</span></span><span class=line><span class=cl><span class=nb>set</span> protocols bgp group lb peer-as <span class=m>65512</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> protocols bgp group lb neighbor 192.0.2.5
</span></span><span class=line><span class=cl><span class=nb>set</span> protocols bgp group lb neighbor 192.0.2.6
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>set</span> policy-options policy-statement bgp_export_none term <span class=m>1</span> <span class=k>then</span> reject
</span></span><span class=line><span class=cl><span class=nb>set</span> policy-options policy-statement bgp_filter_exabgp term <span class=m>1</span> from route-filter 192.0.2.0/24 prefix-length-range /32-/32 accept
</span></span><span class=line><span class=cl><span class=nb>set</span> policy-options policy-statement bgp_filter_exabgp term <span class=m>10</span> <span class=k>then</span> reject</span></span></code></pre></div><h2 id=service>Service</h2><p>The default systemd unit for exabgp/debian is a bit limited so I added some override to create the fifo used to interrogate the daemon from CLI.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>Service<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>User</span><span class=o>=</span>exabgp
</span></span><span class=line><span class=cl><span class=nv>Group</span><span class=o>=</span>exabgp
</span></span><span class=line><span class=cl><span class=nv>RuntimeDirectory</span><span class=o>=</span>exabgp
</span></span><span class=line><span class=cl><span class=nv>RuntimeDirectoryMode</span><span class=o>=</span><span class=m>2750</span>
</span></span><span class=line><span class=cl><span class=nv>ExecStartPre</span><span class=o>=</span>-/usr/bin/mkfifo /run/exabgp/exabgp.in /run/exabgp/exabgp.out</span></span></code></pre></div><h2 id=agent>Agent</h2><p>Last but not least we will need an agent for exabgp, he will extract the services IPs from the dataplaneapi and do some healthcheck before publishing an IP.</p><p><a href=healthcheck-haproxy.py>Haproxy / DataplaneAPI healthcheck Agent</a></p><p>The agent will query haproxy dataplane to extract service IPs, and then tests them using the argument provided check, if everything is ok then a route will be sent over the bgp routers using exabgp.</p><p>This agent is a modified version of exabgp healthcheck.py, more for the fun of it since the original IP discovery using loopback listing could very well do the trick, however there is another modification, the healthcheck command is applied to each service IP and not once globally, so that we only advertise really enabled services.</p><h1 id=starting-the-monster>Starting the monster</h1><p>Time to start the lot, first haproxy and then exabgp:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>root@lb1:~<span class=o>]</span><span class=c1># systemctl haproxy start</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@lb1:~<span class=o>]</span><span class=c1># systemctl status haproxy </span>
</span></span><span class=line><span class=cl>● haproxy.service - HAProxy Load Balancer
</span></span><span class=line><span class=cl>   Loaded: loaded <span class=o>(</span>/etc/systemd/system/haproxy.service<span class=p>;</span> enabled<span class=p>;</span> vendor preset: enabled<span class=o>)</span>
</span></span><span class=line><span class=cl>   Active: active <span class=o>(</span>running<span class=o>)</span> since Sat 2020-04-11 23:52:51 CEST<span class=p>;</span> 1s ago
</span></span><span class=line><span class=cl>     Docs: file:/usr/share/doc/haproxy/configuration.txt.gz
</span></span><span class=line><span class=cl>  Process: <span class=m>96115</span> <span class=nv>ExecStartPre</span><span class=o>=</span>/usr/sbin/haproxy -f <span class=nv>$CONFIG</span> -c -q <span class=o>(</span><span class=nv>code</span><span class=o>=</span>exited, <span class=nv>status</span><span class=o>=</span>0/SUCCESS<span class=o>)</span>
</span></span><span class=line><span class=cl> Main PID: <span class=m>96117</span> <span class=o>(</span>haproxy<span class=o>)</span>
</span></span><span class=line><span class=cl>    Tasks: <span class=m>13</span> <span class=o>(</span>limit: 2322<span class=o>)</span>
</span></span><span class=line><span class=cl>   Memory: 42.6M
</span></span><span class=line><span class=cl>   CGroup: /system.slice/haproxy.service
</span></span><span class=line><span class=cl>           ├─96117 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid
</span></span><span class=line><span class=cl>           ├─96122 /usr/local/bin/dataplaneapi --host 0.0.0.0 --port <span class=m>5555</span> --haproxy-bin /usr/sbin/haproxy --config-file /etc/haproxy/haproxy.cfg --reload-cmd systemctl reload haproxy --reload-delay <span class=m>5</span> --userlist controller
</span></span><span class=line><span class=cl>           └─96123 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Apr <span class=m>11</span> 23:52:51 lb1 haproxy<span class=o>[</span>96117<span class=o>]</span>: Proxy xxx started.
</span></span><span class=line><span class=cl>Apr <span class=m>11</span> 23:52:51 lb1 haproxy<span class=o>[</span>96117<span class=o>]</span>: Proxy xxy started.
</span></span><span class=line><span class=cl>Apr <span class=m>11</span> 23:52:51 lb1 haproxy<span class=o>[</span>96117<span class=o>]</span>: Proxy stats started.
</span></span><span class=line><span class=cl>Apr <span class=m>11</span> 23:52:51 lb1 haproxy<span class=o>[</span>96117<span class=o>]</span>: <span class=o>[</span>NOTICE<span class=o>]</span> 101/235251 <span class=o>(</span>96117<span class=o>)</span> : New program <span class=s1>&#39;api&#39;</span> <span class=o>(</span>96122<span class=o>)</span> forked
</span></span><span class=line><span class=cl>Apr <span class=m>11</span> 23:52:51 lb1 haproxy<span class=o>[</span>96117<span class=o>]</span>: <span class=o>[</span>NOTICE<span class=o>]</span> 101/235251 <span class=o>(</span>96117<span class=o>)</span> : New worker <span class=c1>#1 (96123) forked</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@lb1:~<span class=o>]</span><span class=c1># systemctl start exabgp</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@lb1:~<span class=o>]</span><span class=c1># systemctl status exabgp </span>
</span></span><span class=line><span class=cl>● exabgp.service - ExaBGP
</span></span><span class=line><span class=cl>   Loaded: loaded <span class=o>(</span>/etc/systemd/system/exabgp.service<span class=p>;</span> enabled<span class=p>;</span> vendor preset: enabled<span class=o>)</span>
</span></span><span class=line><span class=cl>   Active: active <span class=o>(</span>running<span class=o>)</span> since Sat 2020-04-11 23:54:42 CEST<span class=p>;</span> 1s ago
</span></span><span class=line><span class=cl>     Docs: https://github.com/Exa-Networks/exabgp/wiki
</span></span><span class=line><span class=cl>  Process: <span class=m>96222</span> <span class=nv>ExecStartPre</span><span class=o>=</span>/usr/bin/mkfifo /run/exabgp/exabgp.in /run/exabgp/exabgp.out <span class=o>(</span><span class=nv>code</span><span class=o>=</span>exited, <span class=nv>status</span><span class=o>=</span>0/SUCCESS<span class=o>)</span>
</span></span><span class=line><span class=cl> Main PID: <span class=m>96223</span> <span class=o>(</span>exabgp<span class=o>)</span>
</span></span><span class=line><span class=cl>    Tasks: <span class=m>3</span> <span class=o>(</span>limit: 2322<span class=o>)</span>
</span></span><span class=line><span class=cl>   Memory: 55.6M
</span></span><span class=line><span class=cl>   CGroup: /system.slice/exabgp.service
</span></span><span class=line><span class=cl>           ├─96223 /usr/bin/python3 /usr/sbin/exabgp /etc/exabgp/exabgp.conf
</span></span><span class=line><span class=cl>           ├─96230 /usr/bin/python3 /usr/local/sbin/healthcheck-haproxy.py -s --api-password &lt;<span class=nb>set</span> a password&gt; --cmd curl --fail --verbose --max-time <span class=m>2</span> http://%s/_healthcheck
</span></span><span class=line><span class=cl>           └─96231 /usr/bin/python3 /usr/sbin/exabgp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Apr <span class=m>11</span> 23:54:43 lb1 exabgp<span class=o>[</span>96223<span class=o>]</span>: 23:54:43 <span class=p>|</span> <span class=m>96223</span>  <span class=p>|</span> interpreter     <span class=p>|</span> 3.7.3 <span class=o>(</span>default, Dec <span class=m>20</span> 2019, 18:57:59<span class=o>)</span>  <span class=o>[</span>GCC 8.3.0<span class=o>]</span>
</span></span><span class=line><span class=cl>Apr <span class=m>11</span> 23:54:43 lb1 exabgp<span class=o>[</span>96223<span class=o>]</span>: 23:54:43 <span class=p>|</span> <span class=m>96223</span>  <span class=p>|</span> os              <span class=p>|</span> Linux lb1 4.19.0-8-amd64 <span class=c1>#1 SMP Debian 4.19.98-1 (2020-01-26) x86_64</span>
</span></span><span class=line><span class=cl>Apr <span class=m>11</span> 23:54:43 lb1 exabgp<span class=o>[</span>96223<span class=o>]</span>: 23:54:43 <span class=p>|</span> <span class=m>96223</span>  <span class=p>|</span> installation    <span class=p>|</span>
</span></span><span class=line><span class=cl>Apr <span class=m>11</span> 23:54:43 lb1 exabgp<span class=o>[</span>96223<span class=o>]</span>: 23:54:43 <span class=p>|</span> <span class=m>96223</span>  <span class=p>|</span> cli control     <span class=p>|</span> named pipes <span class=k>for</span> the cli are:
</span></span><span class=line><span class=cl>Apr <span class=m>11</span> 23:54:43 lb1 exabgp<span class=o>[</span>96223<span class=o>]</span>: 23:54:43 <span class=p>|</span> <span class=m>96223</span>  <span class=p>|</span> cli control     <span class=p>|</span> to send commands  /run/exabgp/exabgp.in
</span></span><span class=line><span class=cl>Apr <span class=m>11</span> 23:54:43 lb1 exabgp<span class=o>[</span>96223<span class=o>]</span>: 23:54:43 <span class=p>|</span> <span class=m>96223</span>  <span class=p>|</span> cli control     <span class=p>|</span> to <span class=nb>read</span> responses /run/exabgp/exabgp.out
</span></span><span class=line><span class=cl>Apr <span class=m>11</span> 23:54:43 lb1 exabgp<span class=o>[</span>96223<span class=o>]</span>: 23:54:43 <span class=p>|</span> <span class=m>96223</span>  <span class=p>|</span> configuration   <span class=p>|</span> performing reload of exabgp 4.0.8-793a2931
</span></span><span class=line><span class=cl>Apr <span class=m>11</span> 23:54:43 lb1 exabgp<span class=o>[</span>96223<span class=o>]</span>: 23:54:43 <span class=p>|</span> <span class=m>96223</span>  <span class=p>|</span> reactor         <span class=p>|</span> loaded new configuration successfully
</span></span><span class=line><span class=cl>Apr <span class=m>11</span> 23:54:43 lb1 exabgp<span class=o>[</span>96223<span class=o>]</span>: 23:54:43 <span class=p>|</span> <span class=m>96223</span>  <span class=p>|</span> reactor         <span class=p>|</span> connected to peer-2 with outgoing-1 192.0.5-192.0.2.2
</span></span><span class=line><span class=cl>Apr <span class=m>11</span> 23:54:43 lb1 exabgp<span class=o>[</span>96223<span class=o>]</span>: 23:54:43 <span class=p>|</span> <span class=m>96223</span>  <span class=p>|</span> reactor         <span class=p>|</span> connected to peer-1 with outgoing-2 192.0.5-192.0.2.2</span></span></code></pre></div></article><hr><nav id=timenav><div id=previnsection><h3>Older</h3><article class=post-link><header><h1><a href=../../../../../blog/2019/12/06/Lets-Encrypt-Chef-Server/>Let's Encrypt Chef-Server</a></h1><p>Hi,
So today i wanted to switch our chef-server certificates from an old internal pki with issues (SHA1 &mldr;) to another solution, and since we are avid users of Let&rsquo;s Encrypt this was my first idea.
However i quickly stumble onto an issue, the chef-server private cookbook aren&rsquo;t &lsquo;compatible&rsquo; with this (ie there is no way to insert some custom nginx rules on the correct location to allow serving of /.</p></article></div><div id=nextinsection><h3>Newer</h3><article class=post-link><header><h1><a href=../../../../../blog/2022/06/18/Upgrading-the-blog-day-360205/>Upgrading the blog, day 360205</a></h1><p>So &mldr;
Hi back i guess ? :)
Years have passed, the previous engine setup proved unreliable, update to jekyll, ruby, and whatever keep breaking up the thing in all ways i could not even think of.
Jekyll-assets particularly seem to have a pretty hard time keeping up with the ecosystem, so &mldr; let&rsquo;s try another way ?
Hugo I found this tool, Hugo ages ago, basically the same concept as jekyll but based on a go software, always wanted to do the switch hopefully it would prove more reliable ?</p></article></div></nav></div></main><footer><div>©2022. Built with <a href=https://gohugo.com/>Hugo</a> custom layout loosely based on <a href=https://github.com/ellekasai/shiori>Jekyll Shiori Theme</a>.</div><div><p>Using: <a href=https://www.w3.org/html/logo/><img src=https://www.w3.org/html/logo/badge/html5-badge-h-css3.png alt="HTML5 Powered with CSS3 / Styling" title="HTML5 Powered with CSS3 / Styling" width=33 height=16></a> <a href="https://validator.w3.org/check?uri=/">Validate</a></p></div></footer></body></html>